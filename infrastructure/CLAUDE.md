# infrastructure

AWS CDK stack (TypeScript). Provisions all backend resources for the German Learning app.

## Commands (run from this directory)

```bash
npm install
npx cdk synth    # synthesise CloudFormation template — no AWS calls
npx cdk diff     # compare deployed stack with local changes
npx cdk deploy   # deploy to AWS
npx cdk destroy  # tear down (S3 + DynamoDB are RETAIN — delete manually)
```

## Stack: `GermanLearningStack` (`lib/german-learning-stack.ts`)

| Resource | Type | Key config |
|---|---|---|
| `RawSourceBucket` | S3 | Versioned, private, RETAIN; triggers ingestion Lambda on `.md` upload |
| `ExercisesTable` | DynamoDB | PK=`level` (S), SK=`typeLesson` (S); PAY_PER_REQUEST, RETAIN |
| `IngestionFunction` | Lambda (Python 3.12) | 10 min timeout, 512 MB; reads S3, calls Bedrock, writes DynamoDB |
| `ExerciseApiFunction` | Lambda (Python 3.12) | 30s timeout; reads DynamoDB |
| `ExercisesApi` | API Gateway (REST) | `GET /exercises/{level}?type=nouns\|verbs\|lesson`; CORS open |

## Entry point

`bin/infrastructure.ts` instantiates `GermanLearningStack` using `CDK_DEFAULT_ACCOUNT` and `CDK_DEFAULT_REGION` from the environment.

## Note on `infrastructure-stack.ts`

`lib/infrastructure-stack.ts` is the empty boilerplate generated by `cdk init`. It is not used. The real stack is `lib/german-learning-stack.ts`.

## Lambda source

Lambda code is bundled from `../../ingestion/lambda_ingestion` and `../../ingestion/lambda_exercise_api` via `lambda.Code.fromAsset(...)`.

## Outputs after deploy

| Output | Use |
|---|---|
| `RawBucketName` | Target for `aws s3 sync data/a1/ s3://<name>/a1/` |
| `ExercisesTableName` | Informational |
| `ExercisesApiUrl` | Set as `VITE_EXERCISES_API_URL` in Amplify Console |
